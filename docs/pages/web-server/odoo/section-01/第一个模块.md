---
headerDepth: 0
prev:
  link: /pages/web-server/odoo/section-01/环境搭建.md
---

## 创建应用(模块)

Odoo 开发通常都是需要创建自己的模块, 而不是在源代码上添加/修改; 下面我们通过创建第一个图书应用, 来学习在 odoo 中二次开发的步骤;

### 模块

模块, 也可以称之为 `应用/插件`, 在 odoo 中, 一个模块就是一个包含完整功能的应用; 可以新增功能, 或者是修改已有的功能; 模块目录必须包含有一个声明文件或者是描述文件 `__manifest__.py`;

一部分模块在 Odoo 中以应用 (app) 的形式出现; 应用是Odoo功能区中的那些顶级模块, 我们希望这一模块出现在 Apps 菜单的顶级. Odoo的基本应用有 `CRM`, `Project` 和 `HR` 等; 非应用模块插件一般依赖于某个应用, 为其添加或扩展功能;

如果新模块为 Odoo 添加新的或重要的功能, 一般应归类为应用; 而如果模块仅修改已有应用的功能, 那就是一个普通的插件模块; (进入 Apps 菜单并按 Category 分组)

![odoo-module](/images/odoo/module.png)

### addons

在上一节中, 我们也看到了配置文件里面的 `addons_path` 配置项, addons 路径包含一系列的目录, 默认的 addons 路径为 `odoo/addons`, 其中存放 odoo 自带的官方应用, 以及 `odoo/odoo/addons`, 其中为提供核心功能的 `base` 模块;

可以看到, 一个 `addons` 其实就是一个包含了多个模块的目录;  因此可以为我们的图书模块新增一个目录; `library`; 新增完成之后, 如果需要 odoo 能够识别到, 还需要在配置文件 `odoo.conf` 里面添加:

```conf{2}
[options]
addons_path = D:\workspace\odoo-16.0\odoo\addons,D:\workspace\odoo-16.0\addons,D:\workspace\odoo-16.0\library
admin_passwd = 123
csv_internal_sep = ,
...
```

### 脚手架

odoo 提供了脚手架工具, 能够快速的帮助我们创建一个标准模块所需要的全部文件:

```bash
# 语法
python odoo-bin scaffold <module> <addons-directory>

# 创建一个 library_app 模块 在 library 目录下
python odoo-bin scaffold library_app ./library
```
创建好的模块文件如下:

```html
library_app/
├── __init__.py
├── __manifest__.py
├── controllers
│   ├── __init__.py
│   └── controllers.py
├── demo
│   └── demo.xml
├── models
│   ├── __init__.py
│   └── models.py
├── security
│   └── ir.model.access.csv
└── views
    ├── templates.xml
    └── views.xml
```
有效的 Odoo 插件目录并包含一个 `__manifest__.py` 描述文件. 模块还应是可导入的, 因此必须包含一个 `__init__.py` 文件. 在目录树结构中可以看到这正是前两个文件

### odoo 模块结构

odoo中模块目录结构:

- `controller`: 所有的网页的控制、路由必须要放在这个文件夹下
- `data`: 存放模块预制数据, 例如 res.partner 中新建想初始化几个客户信息 (name, street…)
- `i18n`: 存放国际化文件
- `models`: 存放模型等py代码
- `security`: 存放权限文件
- `views`: 当前模块的前端可视化代码定义都放在这个文件目录下 (odoo中视图的定义), 列表视图、详情页视图、透视表、搜索视图等等…
- `report`: 模块中有关的报表模型或者相应报表视图文件
- `static`: 前端相关的静态文件目录, scss、xml、js、img 等;
- `__manifest__.py`: 该文件用于声明该模块, 并指定一些模块元数据

创建完成之后, 来修改一下模块的信息, 修改 `__manifest__.py` 如下:

```python{27}
# -*- coding: utf-8 -*-
{
    'name': "library_app",

    'summary': """
        Short (1 phrase/line) summary of the module's purpose, used as
        subtitle on modules listing or apps.openerp.com""",

    'description': """
        Long description of module's purpose
    """,

    'author': "Yuan",
    'website': "https://www.yourcompany.com",
    'category': 'Uncategorized',
    'version': '0.1',
    'depends': ['base'],
    'data': [
        # 'security/ir.model.access.csv',
        'views/views.xml',
        'views/templates.xml',
    ],
    # only loaded in demonstration mode
    'demo': [
        'demo/demo.xml',
    ],
    "application": True,
}
```

常见的 `manifest` 中的键值信息有:

- `name`: 模块的名字;
- `version`: 模块的版本;
- `description`: 描述;
- `author`: 作者;
- `website`: 模块作者的网站地址;
- `license`: 许可;
- `category`: Odoo中的分类类别, 模块的大致业务领域, 对应 web 站点左侧的分类栏;
- `depends`: Odoo模块, 必须在此模块之前加载, 因为这个模块使用它们创建的特性, 或者因为它改变了它们定义的内容. 当安装一个模块时, 它的所有依赖关系都在它之前安装
- `data`: 数据文件列表始终被安装或更新模块时, 从模块根目录列出的路径列表;
- `demo`: 仅在 演示模式 下安装或更新的数据文件列表;
- `auto_install`: 如果是 True, 如果所有的依赖都安装了, 这个模块会自动安装
- `application`: 表示当前模块作为一个独立模块, 安装之后会出现在左侧的展开菜单栏中;
- `assets`: 资源管理, 一般是用来标识 web 端所需要的 js,css,xml 等; (后续详细介绍)

### 加载模块

创建好这一个模块之后, 我们可以验证一下 odoo 是否能够正确的加载我们的模块; 

启动 odoo 服务之后, 打开 debug 模式; (`http://localhost:8091/web?debug=1#`) 然后在菜单中点击 `Update Apps List`;

![update-module](/images/odoo/update-module.png)

然后再搜索 `library_app`:

![library_app](/images/odoo/library_app.png)

### 设置模块分类

模块可以进行分类, 表示相关的功能区, 这些分类用户插件模块的分组, 以及安全组; 如果模块未设置分类, 默认使用 `Uncategorized`, 上面新建的模块就是这一分类;

如果对模块使用了不存在的分类, odoo 就会自动创建分类, 我们利用这一特性为图书应用新建一个分类: `Services/Library`, 编辑 `__manifest__.py` 修改 `category`:

```python
'category': 'Services/Library',
```
分类也可用于组织安全组, 需要相应的 `XML ID` 来在 `XML` 数据文件中引用它们;

分配给模块分类的 `XML ID` 由 `base.module_category_` 加上分类名自动生成; 例如: `Services/Library` 所生成的 `XML ID` 为 `base.module_category_services_library`;

我们可以访问相应的表单视图然后使用开发者菜单中的 `View Metadata` 选项来查看应用分类的 `XML ID`;

应用分类没有菜单项, 但可能过安全组表单访问分类表单, 如下:

1. 打开 `Setting > User > Group` 菜单选项, 新建一条测试记录;
2. 在 `Application` 字段下拉列表中选择 `Library`, 点击保存：
![xml-id](/images/odoo/xmlId.png)
3. 点击 `Application` 链接打开所选的分类对应详情表单;
4. 位于分类表单时, 在开发者菜单中选择 `View Metadata` 查看所分配的 `XML ID`;
![view-metadata](/images/odoo/view_metadata.png)
5. 此时不打算使用就可以删除测试分组了;

> 此外, 可以在 odoo 的源码中查看内置的分类以及它们的 `XML ID`, 对应的文件路径为 `odoo/addons/base/data/ir_module_category_data.xml`;

## 第一个模块

一些 Odoo 模块创建新应用, 而另一些则对已有应用添加功能或作出修改; 虽然两者的技术组件基本相同, 但应用通常包含一些特征性元素; 我们创建的是一个图书应用, 所以应在模块中包含这些元素;

一个完整应用包含的元素如下:
- 图标: 用于在应用列表中展示;
- 顶级菜单: 其下放置应用的所有菜单项;
- 模型: 模型对应的是数据库中数据表, 但是模型的概念比表更多, 很多属性并不存储在数据库中;
- 视图: 视图层为用户界面的描述, 视图用 XML 定义, 由网页客户端框架生成数据可知的 HTML 视图;
- 应用安全组: 通过访问权限仅对指定用户开发;

### 添加图标

推荐一个免费图标库 [图标](https://www.iconarchive.com/search?q=book)

模块可以选择一个自己的图标, 对于创建为应用的模块, 这尤为重要, 因为应用会在 apps 菜单下显示图标;

需要对模块添加 `static/description/icon.png` 文件;

### 安装模块

现在我们已经有了一个精简的插件模块, 尚未实现任何功能, 但我们可以通过安装它来检查是否能正常运行;

安装新模块, 在启动服务的时候使用 `-d` 和 `-i` 参数, `-d` 参数确保我们使用正确的 odoo 数据库, `-i` 参数接收一个待安装的逗号分隔模块列表;

对于新建的 `library_app` 模块, 可以使用以下命令来启动并安装;

```bash
python odoo-bin -c ./odoo.conf -d odoo_16_test_20231127 -i library_app
```
我们添加了 `-d` 参数来指定正确的数据库进行安装, 如果在配置文件中已经进行指定, 这个参数就是多余的, 尽管如此, 出于安全保障, 最好在命令行中声明安装的数据库;

当然, 我们也可以通过 web 界面, 来安装应用; 正常启动之后进入 `Apps >` 搜索 `library_app`, 点击安装, 跟上面命令行安装的效果是一致的;

### 升级模块

开发模块是一个不断迭代的过程, 对源码不断的在修改并在 odoo 中应用;

可以在 `web` 界面 的 `Apps` 列表中查找模块并点击 `Upgrade` 按钮, 这会重新加载数据文件, 应用所做的修改并升级数据库模式; 但如果修改的是 `python` 逻辑, 点击升级还不够; 需要重启 odoo 服务来重新加载修改后的 python 代码; 有时候模块中即修改了数据文件, 又修改了 python 逻辑, 那么就需要同时进行如上两种操作;

总结起来:
- 修改模型或字段时, 需要进行升级来应用数据库的修改;
- 修改 `python` 逻辑时, 需要重启来重新加载代码文件;
- 修改 `xml` 或者是 `csv` 文件时, 需要升级来重新应用文件中的数据;

为避免修改 Odoo 代码时所产生的困惑和阻力, 最简单的方案是在修改代码后通过升级命令重启 Odoo 服务; 可以使用如下命令:

```bash
python odoo-bin -c ./odoo.conf -d odoo_16_test_20231127 -u library_app --dev=all
```
`-u` 参数要求使用 `-d` 参数, 并接收一个逗号分隔的待升级模块; 例如可以使用 `-u library_app, mail`; **模块升级后, 所有依赖该模块的模块也会被升级**;

### 添加应用菜单

我们创建的是一个新应用, 因此应包含主菜单项, 在社区版中, 位于左上角的下拉菜单中, 而在企业版中, 则作为附加图标显示在应用切换器主界面中;

菜单项是使用 `xml` 数据文件添加的视图组件, 通过创建 `views/library_menu.xml` 文件添加以下内容来定义菜单项:

```xml
<odoo>
    <data>
        <menuitem id="menu_library" name="Library" />
    </data>
</odoo>
```
用户界面, 包含菜单项和操作, 均存储于数据表中供客户端实时读取解释; 上面的文件描述了要载入 Odoo 数据库的记录, `<menuitem>` 元素指示在存储 Odoo 菜单项的 `ir.ui.menu` 模型上写入一条记录;

id 属性也称作 `XML ID`, 用于唯一标识每个数据元素, 以供其它元素引用; 例如在添加图书子菜单时, 就需要引用父级菜单项的 `XML ID`, 即 `menu_library`;

此处添加的菜单项非常简单, 仅用到了一个属性 `name`, 其它常用的属性这里没有使用; 常用的属性有:

- `parent`: 父级菜单的 `xml id`, 如果没有设置, 则将 name 属性作为菜单名称, 并在菜单层次结构中查找位置;
- `name`: 菜单名称;
- `groups`: 菜单的权限组, 如果设置了, 则只有相关权限的组的人员才能访问; `res.groups` 模型的外部标识符的逗号分隔; 如果以 `!` 为前缀, 则从该组将从菜单的组中删除;
- `action`: 打开菜单时要执行的操作的外部 `xml id`;
- `id`: 菜单的 `xml id`;

图书模块还不知道 XML 数据文件的存在, 我们还需要在声明中使用 data 属性来添加, 载入到 odoo 实例中; 编辑 `__manifest__.py`, 添加以下内容:

```python
'data': [
    'views/library_menu.xml',
],
```
`data` 声明键是一个在安装或升级模块时加载的数据文件列表; 文件路径为声明文件所丰的根目录的相对路径;


