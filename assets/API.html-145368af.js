import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-9b0cd270.js";const p={},e=t(`<h2 id="api" tabindex="-1"><a class="header-anchor" href="#api" aria-hidden="true">#</a> API</h2><p>odoo API模块定义 Odoo 环境和方法装饰器; 这里对 odoo 的常见的 api 进行学习, 后面会深入 ORM 模型进行学习;</p><h3 id="api-autovacuum" tabindex="-1"><a class="header-anchor" href="#api-autovacuum" aria-hidden="true">#</a> @api.autovacuum</h3><p><code>@api.autovacuum(method)</code></p><p>在执行 CRUD 操作(增删改查) 后自动执行清理工作; 它用于自动清理数据库中的孤立记录, 即那些与其它记录没有关联的记录, 并且在删除其关联记录时没有被自动删除的记录;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>autovacuum</span>
<span class="token keyword">def</span> <span class="token function">_archive_meeting_rooms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot; 如果暂时没有人加入, 则将 0 参与者的所有非固定房间存档 &quot;&quot;&quot;</span>
    self<span class="token punctuation">.</span>sudo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">&quot;is_pinned&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&quot;active&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&quot;room_participant_count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&quot;room_last_activity&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> fields<span class="token punctuation">.</span>Datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>_DELAY_CLEAN<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="api-constrains" tabindex="-1"><a class="header-anchor" href="#api-constrains" aria-hidden="true">#</a> @api.constrains</h3><p><code>@api.constrains(*args)</code></p><p>装饰约束检查器, 参数为需要进行约束的字段; 当对数据记录进行保存的时候触发校验;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>constrains</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;description&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_check_description</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> record <span class="token keyword">in</span> self<span class="token punctuation">:</span>
        <span class="token keyword">if</span> record<span class="token punctuation">.</span>name <span class="token operator">==</span> record<span class="token punctuation">.</span>description<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&quot;Fields name and description must be different&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>@api.constrains</code> 只支持对简单字段进行约束, 不支持 <code>relational</code> 关系字段进行约束; eg: <code>partner_id.customer</code>; 只有当装饰器方法中声明的字段包含在 write 或者 create 时才会被调用; 这也就意味着视图中不存在的字段在创建/编辑的时候不会被校验;</p></blockquote><p>odoo 支持另外一种添加限制的方式, 即通过 sql 约束的方式; 方法是在 odoo 类中添加一个 <code>_sql_constraints</code> 属性, 值是一个包含了元组的列表, 元组的三个值分别是: 约束名, 条件, 警告信息;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>_sql_constraints <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">&#39;name_description_check&#39;</span><span class="token punctuation">,</span>
     <span class="token string">&#39;CHECK(name != description)&#39;</span><span class="token punctuation">,</span>
     <span class="token string">&quot;The title of the course should not be the description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;name_unique&#39;</span><span class="token punctuation">,</span>
     <span class="token string">&#39;UNIQUE(name)&#39;</span><span class="token punctuation">,</span>
     <span class="token string">&quot;The course title must be unique&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样做的好处是, 在数据库层面就限制了数据的校验, 而不是在代码层面的校验, 显然效率会更高; 缺点是在添加限制之前, 数据库中不能存在违反约束的数据, 否则约束会添加失败;</p><h3 id="api-depends" tabindex="-1"><a class="header-anchor" href="#api-depends" aria-hidden="true">#</a> @api.depends</h3><p><code>@api.depends(*args)</code></p><p>指定计算属性方法的依赖字段; 如果有多个, 可以使用 <code>,</code> 隔开;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>pname <span class="token operator">=</span> fields<span class="token punctuation">.</span>Char<span class="token punctuation">(</span>compute<span class="token operator">=</span><span class="token string">&#39;_compute_pname&#39;</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>depends</span><span class="token punctuation">(</span><span class="token string">&#39;partner_id.name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;partner_id.is_company&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_compute_pname</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> record <span class="token keyword">in</span> self<span class="token punctuation">:</span>
        <span class="token keyword">if</span> record<span class="token punctuation">.</span>partner_id<span class="token punctuation">.</span>is_company<span class="token punctuation">:</span>
            record<span class="token punctuation">.</span>pname <span class="token operator">=</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>partner_id<span class="token punctuation">.</span>name <span class="token keyword">or</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            record<span class="token punctuation">.</span>pname <span class="token operator">=</span> record<span class="token punctuation">.</span>partner_id<span class="token punctuation">.</span>name
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 <code>compute</code> 方法来说, 加不加 <code>depends</code> 装饰的区别在于: 加了 <code>depends</code> 的方法会在依赖的字段发生改变时重新计算本字段的值, 而不加 <code>depends</code> 的方法只在触发的第一次调用, 也就是说不会持续更新;</p><h3 id="api-depends-context" tabindex="-1"><a class="header-anchor" href="#api-depends-context" aria-hidden="true">#</a> @api.depends_context</h3><p><code>@api.depends_context(*args)</code></p><p>指定计算属性方法的依赖字段; 字段来源于 <code>context</code> 的上下文中; 如果有多个, 可以使用 <code>,</code> 隔开;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>depends_context</span><span class="token punctuation">(</span><span class="token string">&#39;pricelist&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;quantity&#39;</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>depends</span><span class="token punctuation">(</span><span class="token string">&#39;product_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;price&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_compute_price_reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> category <span class="token keyword">in</span> self<span class="token punctuation">:</span>
        product <span class="token operator">=</span> category<span class="token punctuation">.</span>product_id
        pricelist <span class="token operator">=</span> product<span class="token punctuation">.</span>product_tmpl_id<span class="token punctuation">.</span>_get_contextual_pricelist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        lst_price <span class="token operator">=</span> product<span class="token punctuation">.</span>currency_id<span class="token punctuation">.</span>_convert<span class="token punctuation">(</span>
            product<span class="token punctuation">.</span>lst_price<span class="token punctuation">,</span>
            pricelist<span class="token punctuation">.</span>currency_id<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>company<span class="token punctuation">,</span>
            fields<span class="token punctuation">.</span>Datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        discount <span class="token operator">=</span> <span class="token punctuation">(</span>lst_price <span class="token operator">-</span> product<span class="token punctuation">.</span>_get_contextual_price<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> lst_price <span class="token keyword">if</span> lst_price <span class="token keyword">else</span> <span class="token number">0.0</span>
        category<span class="token punctuation">.</span>price_reduce <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> discount<span class="token punctuation">)</span> <span class="token operator">*</span> category<span class="token punctuation">.</span>price
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="api-model" tabindex="-1"><a class="header-anchor" href="#api-model" aria-hidden="true">#</a> @api.model</h3><p><code>@api.model(method)</code></p><p><code>api.model</code> 装饰的方法, 其 self 只代表模型, 不含有具体的记录值; 典型的应用时对象的 <code>create</code> 方法:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>model</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>vals<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span>Book<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>vals<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>create</code> 方法不会获取页面中标注为 <code>readonly</code> 的字段的值, 如果想要保存只读字段的值, 请将其 <code>force_save</code> 属性设置为 <code>True</code>;</p></blockquote><p>如果需要某一个方法提供给 js 的 rpc 调用, 需要使用 <code>@api.model</code> 装饰器进行装饰;</p><h3 id="api-model-create-multi" tabindex="-1"><a class="header-anchor" href="#api-model-create-multi" aria-hidden="true">#</a> @api.model_create_multi</h3><p><code>@api.model_create_multi(method)</code></p><p>将 create 方法转换为创建多个记录的方法;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>model_create_multi</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vals_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> vals <span class="token keyword">in</span> vals_list<span class="token punctuation">:</span>
        zip_from <span class="token operator">=</span> vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;zip_from&#39;</span><span class="token punctuation">)</span>
        zip_to <span class="token operator">=</span> vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;zip_to&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> zip_from <span class="token keyword">and</span> zip_to<span class="token punctuation">:</span>
            vals<span class="token punctuation">[</span><span class="token string">&#39;zip_from&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vals<span class="token punctuation">[</span><span class="token string">&#39;zip_to&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_convert_zip_values<span class="token punctuation">(</span>zip_from<span class="token punctuation">,</span> zip_to<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>vals_list<span class="token punctuation">)</span>
    
<span class="token comment"># record = model.create(vals)  --&gt;  records = model.create([vals, ...])</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="api-onchange" tabindex="-1"><a class="header-anchor" href="#api-onchange" aria-hidden="true">#</a> @api.onchange</h3><p><code>@api.onchange(*args)</code></p><p>通常用于表单视图, 当指定的字段被修改时, 调用该方法;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>onchange</span><span class="token punctuation">(</span><span class="token string">&#39;country_id&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_onchange_country_id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>country_id<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>zip_from <span class="token operator">=</span> self<span class="token punctuation">.</span>zip_to <span class="token operator">=</span> self<span class="token punctuation">.</span>country_group_id <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>state_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>states_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>country_id<span class="token punctuation">.</span>state_ids<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>onchange</code> 可以有返回值可以没有返回值, 返回值由一个字典组成, 可选的值有 <code>value</code> 和 <code>warning</code>, <code>value</code> 用来返回需要设置的字段值, <code>warning</code> 用来返回一些警告信息;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>onchange</span><span class="token punctuation">(</span><span class="token string">&#39;amount&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;unit_price&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_onchange_price</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>price <span class="token operator">=</span> self<span class="token punctuation">.</span>amount <span class="token operator">*</span> self<span class="token punctuation">.</span>unit_price
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;warning&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;title&#39;</span><span class="token punctuation">:</span> <span class="token string">&quot;Something bad happened&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> <span class="token string">&quot;It was very bad indeed&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;notification&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="api-ondelete" tabindex="-1"><a class="header-anchor" href="#api-ondelete" aria-hidden="true">#</a> @api.ondelete</h3><p><code>@api.ondelete(*, at_uninstall)</code></p><p>通过使用这个装饰器, 可以为模型的 <code>unlink()</code> 方法定义特定的行为; 比如在删除记录之前或之后执行特定的操作; 这可以让我们更好地控制记录删除时的行为, 从而确保系统在记录删除时能够按照您的需求执行相应的操作;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>ondelete</span><span class="token punctuation">(</span>at_uninstall<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">_unlink_if_partner_in_account_move</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    以下情况不能删除合作伙伴(联系人):
    - partner in &#39;account.move&#39;
    - state: all states (draft and posted)
    &quot;&quot;&quot;</span>
    moves <span class="token operator">=</span> self<span class="token punctuation">.</span>sudo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;account.move&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search_count<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">&#39;partner_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;in&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;in&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;draft&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;posted&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> moves<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> UserError<span class="token punctuation">(</span>_<span class="token punctuation">(</span><span class="token string">&quot;The partner cannot be deleted because it is used in Accounting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>用 <code>ondelete</code> 修饰的方法应在某些条件下引发错误, 按照规范, 应该将方法命名为 <code>_unlink_if_&lt;condition&gt;</code> 或者 <code>_unlink_except_&lt;not_condition&gt;</code></p></blockquote><h3 id="api-returns" tabindex="-1"><a class="header-anchor" href="#api-returns" aria-hidden="true">#</a> @api.returns</h3><p><code>@api.returns(model, downgrade=None, upgrade=None)</code></p><p>主要是用来指定返回值的格式, 它接受三个参数, 第一个为返回值的 <code>model</code>, 第二个为向下兼容的 <code>method</code>, 第三个为向上兼容的 <code>method</code>; 主要用于确保新旧 API 返回值的一致;</p><p>第一个参数如果是对象本身, 则写 <code>&#39;self&#39;</code>, 如果是其他对象, 则写其他对象名如: <code>@api.returns(&#39;ir.ui.view&#39;)</code></p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>returns</span><span class="token punctuation">(</span><span class="token string">&#39;self&#39;</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> value<span class="token punctuation">:</span> value<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">copy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>ensure_one<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sup <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ResUsers<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> default <span class="token keyword">or</span> <span class="token keyword">not</span> default<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;email&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sup <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ResUsers<span class="token punctuation">,</span> self<span class="token punctuation">.</span>with_context<span class="token punctuation">(</span>no_reset_password<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> sup<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>default<span class="token operator">=</span>default<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="env" tabindex="-1"><a class="header-anchor" href="#env" aria-hidden="true">#</a> ENV</h2><p><code>Environment</code> 对象代表了当前事务的数据库会话和模型记录集合; 它提供了访问数据库中的记录, 执行搜索, 更新和创建新记录的方法; <code>Environment</code> 对象还包含了当前事务中模型的元数据信息, 如字段定义, 操作权限等;</p><p>该环境存储 ORM 的各种上下文的数据:</p><ul><li><strong><code>cr</code></strong>: 当前环境使用的数据库的指针;</li><li><strong><code>uid</code></strong>: 当前用户的 id;</li><li><strong><code>context</code></strong>: 当前上下文字典;</li><li><strong><code>su</code></strong>: 是否是在超级用户模式;</li><li><strong><code>lang</code></strong>: 当前环境中使用的语言;</li><li><strong><code>user</code></strong>: <code>res.users</code> 的当前用户的实例;</li><li><strong><code>company</code></strong>: 当前用户的所属公司的实例;</li><li><strong><code>companies</code></strong>: 当前用户已启用的公司的记录集;</li></ul><p><code>env</code> 环境中还提供了一些便捷的方法:</p><ul><li><strong><code>env.ref(xml_id, raise_if_not_found=True)</code></strong>: 获取 <code>xml_id</code> 的 id;</li><li><strong><code>env.is_superuser()</code></strong>: 是否是在超级用户模式;</li><li><strong><code>env.is_admin()</code></strong>: 是否有用户组访问权限, 或是否是超级用户模式;</li><li><strong><code>env.is_system()</code></strong>: 是否有 <code>setting</code> 访问权限, 或者是否是超级用户模式;</li></ul><p>改变环境变量的方法, odoo 的环境变量是不可以直接修改的, 需要使用以下方法对模型下的静态方法进行修改:</p><ul><li><strong><code>Model.width_context([context][, **overrides])</code></strong>: 扩展上下文或合并覆盖当前的上下文;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># current context is {&#39;key1&#39;: True}</span>

r2 <span class="token operator">=</span> records<span class="token punctuation">.</span>with_context<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key2<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># -&gt; r2._context is {&#39;key2&#39;: True}</span>

r2 <span class="token operator">=</span> records<span class="token punctuation">.</span>with_context<span class="token punctuation">(</span>key2<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># -&gt; r2._context is {&#39;key1&#39;: True, &#39;key2&#39;: True}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.with_user(user)</code></strong>: 在非超级用户模式下, 返回附加到给定用户的此记录集的新版本;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> odoo <span class="token keyword">import</span> SUPERUSER_ID<span class="token punctuation">,</span> api<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> models<span class="token punctuation">,</span> _

<span class="token comment"># 使用超级用户下面的数据</span>
<span class="token keyword">def</span> <span class="token function">action_confirm</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>action_confirm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>su<span class="token punctuation">:</span>
        self <span class="token operator">=</span> self<span class="token punctuation">.</span>with_user<span class="token punctuation">(</span>SUPERUSER_ID<span class="token punctuation">)</span>

    <span class="token keyword">for</span> order <span class="token keyword">in</span> self<span class="token punctuation">:</span>
        <span class="token keyword">if</span> order<span class="token punctuation">.</span>sale_order_template_id <span class="token keyword">and</span> order<span class="token punctuation">.</span>sale_order_template_id<span class="token punctuation">.</span>mail_template_id<span class="token punctuation">:</span>
            order<span class="token punctuation">.</span>sale_order_template_id<span class="token punctuation">.</span>mail_template_id<span class="token punctuation">.</span>send_mail<span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.with_company(company)</code></strong>: 返回指定公司下的记录集;</li><li><strong><code>Model.with_env(env)</code></strong>: 可以确保在特定的环境中处理记录, 有助于避免环境上下文的混淆和数据的隔离;</li><li><strong><code>Model.sudo([flag=True])</code></strong>: 返回启用/禁用超级用户模式的此记录集的新实例; 使用 <code>sudo</code> 不会更改当前用户, 只是跳过部分访问权的限制;</li></ul><h2 id="sql-执行" tabindex="-1"><a class="header-anchor" href="#sql-执行" aria-hidden="true">#</a> SQL 执行</h2><p><code>env</code> 上的 <code>cr</code> 属性是当前数据库事务的指针, 允许直接执行 <code>sql</code>, 无论是对于难以使用 ORM 表达式实现的复杂查询, 还是出于性能原因; <code>self.env.cr</code> 中的对象是对 <code>postgresql</code> 游标的轻度封装. 以下的方法是最常执行的一部分方法:</p><ul><li><strong><code>execute(query, params)</code></strong>: 通过 <code>params</code> 参数值元组替换查询中标记为 <code>%s</code> 的参数来执行SQL查询;</li><li><strong><code>fetchone()</code></strong>: 从数据库返回一行, 以元组进行封装(即便是仅查询了一个字段);</li><li><strong><code>fetchall()</code></strong>: 以元组列表从数据库中返回所有行;</li><li><strong><code>dictfetchall()</code></strong>: 以列名对值的映射字典列表返回数据库中的所有行;</li></ul><blockquote><p>更多 cr 的方法请查看 <code>odoo\\sql_db.py</code> 源码</p></blockquote><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;some_sql&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>

<span class="token comment"># 查询sql</span>
self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>\`sql\`<span class="token punctuation">)</span>
<span class="token comment"># 当前 sql 查询的所有字段名</span>
headers <span class="token operator">=</span> <span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>description<span class="token punctuation">]</span>
<span class="token comment"># 当前 sql 查询的所有数据</span>
records <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 当前 sql 查询出来的记录 total</span>
rowcount <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>rowcount
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意: 执行原生 sql 会绕过 orm , 从而绕过 odoo 的记录规则以及权限规则; 在使用的时候, 请确保 sql 语句的安全性;</p></blockquote><p>关于模型, 需要了解的一件重要事情是, 它们不一定立即执行数据库更新; 事实上, 由于性能原因, 框架在修改记录后延迟了字段的重新计算; 一些数据库更新也被延迟了; 因此, 在查询数据库之前, 必须确保它包含查询的相关数据. 此操作称为刷新, 并执行预期的数据库更新;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 刷新模型, 确保模型上的 \`partner_id\` 是最新的数据</span>
self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;model&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flush_model<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;partner_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT id FROM model WHERE partner_id IN %s&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ids<span class="token punctuation">]</span><span class="token punctuation">)</span>
ids <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在每次 sql 查询之前, 都必须刷新该查询所需的数据; 刷新数据有三个级别, 每个级别都有自己的 api; 可以刷新所有内容, 模型的所有记录 或 某些特定的记录; 因为延迟更新通常会提高性能, 所以我们建议在刷新时要特别注意:</p><ul><li><strong><code>env.flush_all()</code></strong>: 将所有挂起的计算和更新刷新到数据库;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>model_create_multi</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vals_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    events <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>EventEvent<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>vals_list<span class="token punctuation">)</span>
    <span class="token keyword">for</span> res <span class="token keyword">in</span> events<span class="token punctuation">:</span>
        <span class="token keyword">if</span> res<span class="token punctuation">.</span>organizer_id<span class="token punctuation">:</span>
            res<span class="token punctuation">.</span>message_subscribe<span class="token punctuation">(</span><span class="token punctuation">[</span>res<span class="token punctuation">.</span>organizer_id<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>flush_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> events 
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.flush_model(fnames=None)</code></strong>: 刷新 <code>self</code> 当前模型上面的指定字段的数据;</li><li><strong><code>Model.flush_recordset(fnames=None)</code></strong>: 自行处理挂起的计算和记录上的数据库更新. 当给定参数时, 该方法保证至少将记录自身上的给定字段刷新到数据库中;</li></ul><p>由于模型使用相同的游标, 而环境中包含各种缓存, 因此在原始 <code>sql</code> 中更改数据库时, 这些缓存必须无效; 在 SQL 中使用 <code>CREATE</code> , <code>UPDATE</code> 或 <code>DELETE</code> 时, 有必要清除缓存, 而不是 <code>SELECT</code>;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 确保数据库中的 state 字段是最新的</span>
self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;model&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flush_model<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;UPDATE model SET state=%s WHERE state=%s&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;new&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;old&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 使缓存中的 state 字段无效</span>
self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;model&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>invalidate_model<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>就像刷新一样, 可以使整个缓存, 模型的所有记录的缓存或特定记录的缓存无效; 甚至可以使模型的某些记录或所有记录上的特定字段无效. 由于缓存通常会提高性能, 因此我们建议在无效时进行特定处理;</p><ul><li><strong><code>env.invalidate_all(flush=True)</code></strong>: 使所有的记录缓存都无效;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@api<span class="token punctuation">.</span>model</span>
<span class="token keyword">def</span> <span class="token function">schedule_communications</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> autocommit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    schedulers <span class="token operator">=</span> self<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">&#39;event_id.active&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&#39;mail_done&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&#39;scheduled_date&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&lt;=&#39;</span><span class="token punctuation">,</span> fields<span class="token punctuation">.</span>Datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> scheduler <span class="token keyword">in</span> schedulers<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>browse<span class="token punctuation">(</span>scheduler<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            _logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>invalidate_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_warn_template_error<span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> autocommit <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;testing&#39;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span> 
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.invalidate_model(fnames=None, flush=True)</code></strong>: 当前模型上缓存的值与数据库的值不在对应的时候, 使当前模型上的所有的记录缓存无效;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vals<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>_sanitize_vals<span class="token punctuation">(</span>vals<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">&#39;uom_id&#39;</span> <span class="token keyword">in</span> vals <span class="token keyword">or</span> <span class="token string">&#39;uom_po_id&#39;</span> <span class="token keyword">in</span> vals<span class="token punctuation">:</span>
        uom_id <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;uom.uom&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span>vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;uom_id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>uom_id
        uom_po_id <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;uom.uom&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span>vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;uom_po_id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>uom_po_id
        <span class="token keyword">if</span> uom_id <span class="token keyword">and</span> uom_po_id <span class="token keyword">and</span> uom_id<span class="token punctuation">.</span>category_id <span class="token operator">!=</span> uom_po_id<span class="token punctuation">.</span>category_id<span class="token punctuation">:</span>
            vals<span class="token punctuation">[</span><span class="token string">&#39;uom_po_id&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> uom_id<span class="token punctuation">.</span><span class="token builtin">id</span>
    res <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ProductTemplate<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>vals<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">&#39;attribute_line_ids&#39;</span> <span class="token keyword">in</span> vals <span class="token keyword">or</span> <span class="token punctuation">(</span>vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>product_variant_ids<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_create_variant_ids<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">&#39;active&#39;</span> <span class="token keyword">in</span> vals <span class="token keyword">and</span> <span class="token keyword">not</span> vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>with_context<span class="token punctuation">(</span>active_test<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapped<span class="token punctuation">(</span><span class="token string">&#39;product_variant_ids&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">:</span> vals<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">&#39;image_1920&#39;</span> <span class="token keyword">in</span> vals<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;product.product&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>invalidate_model<span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string">&#39;image_1920&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;image_1024&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;image_512&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;image_256&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;image_128&#39;</span><span class="token punctuation">,</span>
            <span class="token string">&#39;can_image_1024_be_zoomed&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res 
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.invalidate_recordset(fnames=None, flush=True)</code></strong>: 当缓存的值不再与数据库值对应时, 使 <code>self</code>当前模型中记录的缓存无效; 如果给定了参数, 则只有 <code>self</code> 上的给定字段从缓存中无效;</li></ul><p>上述方法使缓存和数据库保持一致. 然而, 如果已在数据库中修改了计算字段相关性, 则必须通知要重新计算的计算字段的模型; 框架唯一需要知道的是哪些字段在哪些记录上发生了更改;</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 确保数据库中的 state 是最新的</span>
self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;model&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flush_model<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 使用 RETURNING 子句检索已更改的行</span>
self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;UPDATE model SET state=%s WHERE state=%s RETURNING id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;new&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;old&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ids <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># 使缓存无效, 并将更新通知给框架;</span>
records <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;model&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span>ids<span class="token punctuation">)</span>
records<span class="token punctuation">.</span>invalidate_recordset<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
records<span class="token punctuation">.</span>modified<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有很多方法可以清楚的知道哪些记录被修改了, 在上面的例子中我们利用 <code>postgresql</code> 的 <code>RETURNING</code> 子句来检索信息, 而不需要进行额外的查询;</p><ul><li><strong><code>Model.modified(fnames, create=False, before=False)</code></strong>: 通知自己将修改或已经修改字段; 这将在必要时使缓存无效, 并准备重新计算相关存储字段;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_ondelete_stock_moves</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    modified_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;qty_received_manual&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;qty_received_method&#39;</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>flush_recordset<span class="token punctuation">(</span>fnames<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;qty_received&#39;</span><span class="token punctuation">,</span> <span class="token operator">*</span>modified_fields<span class="token punctuation">]</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>invalidate_recordset<span class="token punctuation">(</span>fnames<span class="token operator">=</span>modified_fields<span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    query <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&#39;&#39;&#39;
        UPDATE </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_table<span class="token punctuation">}</span></span><span class="token string">
        SET qty_received_manual = qty_received, qty_received_method = &#39;manual&#39;
        WHERE id IN %(ids)s
    &#39;&#39;&#39;</span></span>
    self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>cr<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;ids&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_ids <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>modified<span class="token punctuation">(</span>modified_fields<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="curd-方法" tabindex="-1"><a class="header-anchor" href="#curd-方法" aria-hidden="true">#</a> CURD 方法</h2><p>上面介绍了多种 api 装饰器以及环境变量和函数的一些用法, 下面来了解一下 odoo orm 框架的标准 <code>CURD</code> 方法的用法;</p><h3 id="create-update" tabindex="-1"><a class="header-anchor" href="#create-update" aria-hidden="true">#</a> Create/Update</h3><ul><li><strong><code>Model.create(vals_list) -&gt; records</code></strong>: 为模型创建新的记录; 返回值是当前模型的实例;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>user <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.users&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;I am accountman!&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;login&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;accountman&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;password&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;accountman&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;groups_id&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cls<span class="token punctuation">.</span>env<span class="token punctuation">.</span>user<span class="token punctuation">.</span>groups_id<span class="token punctuation">.</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> cls<span class="token punctuation">.</span>env<span class="token punctuation">.</span>ref<span class="token punctuation">(</span><span class="token string">&#39;account.group_account_manager&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> cls<span class="token punctuation">.</span>env<span class="token punctuation">.</span>ref<span class="token punctuation">(</span><span class="token string">&#39;account.group_account_user&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

records <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.currency.rate&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&#39;currency_id&#39;</span><span class="token punctuation">:</span> cls<span class="token punctuation">.</span>env<span class="token punctuation">.</span>ref<span class="token punctuation">(</span><span class="token string">&#39;base.EUR&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;2010-01-02&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;rate&#39;</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;currency_id&#39;</span><span class="token punctuation">:</span> cls<span class="token punctuation">.</span>env<span class="token punctuation">.</span>ref<span class="token punctuation">(</span><span class="token string">&#39;base.USD&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;2010-01-02&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;rate&#39;</span><span class="token punctuation">:</span> <span class="token number">1.2834</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;currency_id&#39;</span><span class="token punctuation">:</span> cls<span class="token punctuation">.</span>env<span class="token punctuation">.</span>ref<span class="token punctuation">(</span><span class="token string">&#39;base.USD&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&#39;%Y-06-05&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#39;rate&#39;</span><span class="token punctuation">:</span> <span class="token number">1.5289</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.copy(default=None)</code></strong>: 重复记录使用默认值自我更新;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>attachment <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;ir.attachment&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&#39;res_model&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;hr.expense&#39;</span><span class="token punctuation">,</span> 
    <span class="token string">&#39;res_id&#39;</span><span class="token punctuation">:</span> <span class="token number">122</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.default_get(fields_list) -&gt; default_values</code></strong>: 返回 <code>fields_list</code> 中字段的默认值, 默认值由上下文, 用户默认值和模型本身决定;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>defaults <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;account.tax&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>with_company<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>default_get<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">&#39;invoice_repartition_line_ids&#39;</span><span class="token punctuation">,</span> 
    <span class="token string">&#39;refund_repartition_line_ids&#39;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.name_create(name) -&gt; record</code></strong>: 通过调用 <code>create()</code> 方法创建一个新的记录, 只提供一个值: 新纪录的显示名称;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>category_id <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;uom.category&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>with_context<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name_create<span class="token punctuation">(</span><span class="token string">&#39;Unsorted/Imported Units&#39;</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>Model.write(vals)</code></strong>: 使用提供的值更新当前的所有记录;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>partner <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.partner&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

partner<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&#39;signup_token&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> 
    <span class="token string">&#39;signup_type&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> 
    <span class="token string">&#39;signup_expiration&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="search-read" tabindex="-1"><a class="header-anchor" href="#search-read" aria-hidden="true">#</a> Search/Read</h3><ul><li><strong><code>Model.browse([ids]) -&gt; records</code></strong>: 返回值为查询的 id 的记录集的实例;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 查询一条记录</span>
partner <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.partner&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>

<span class="token comment"># 查询多条记录</span>
partners <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.partner&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.search(domain[, offset=0][, limit=None][, order=None][, count=False])</code></strong>: 根据条件查询当前模型下面的所有的记录;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>users <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.users&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;xiangyuan&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>Model.search_count(domain) -&gt; int</code></strong>: 返回当前模型中与 domain 匹配的记录集的数量;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>leads <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;crm.lead&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search_count<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">&#39;type&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;opportunity&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>user_id<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;probability&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;date_closed&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&gt;=&#39;</span><span class="token punctuation">,</span> date_utils<span class="token punctuation">.</span>start_of<span class="token punctuation">(</span>fields<span class="token punctuation">.</span>Datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;year&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;date_closed&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&lt;&#39;</span><span class="token punctuation">,</span> date_utils<span class="token punctuation">.</span>end_of<span class="token punctuation">(</span>fields<span class="token punctuation">.</span>Datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;year&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.name_search(name=&#39;&#39;, args=None, operator=&#39;ilike&#39;, limit=100) -&gt; records</code></strong>: 通过给定运算符搜索显示名称与给定名称匹配的记录;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>product_names <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;product.template&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name_search<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&#39;PTN&#39;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&#39;not ilike&#39;</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>Model.read([fields])</code></strong>: 读取当前记录中的请求字段;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>mail_values <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;mail.mail&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;email_from&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mail_server_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>Model.read_group(domain, fields, groupby, offset=0, limit=None, orderby=False, lazy=True)</code></strong>: 主要用于在 <code>Odoo</code> 模型中执行类似 <code>SQL</code> 中的 <code>GROUP BY</code> 操作; 其中: <ul><li><strong><code>domain</code></strong>: 过滤记录的条件;</li><li><strong><code>fields</code></strong>: 要过滤的字段列表;</li><li><strong><code>groupby</code></strong>: 要分组的字段列表;</li><li><strong><code>offset</code></strong>: 偏移量;</li><li><strong><code>limit</code></strong>: limit 结果集限制条数;</li><li><strong><code>orderby</code></strong>: 结果排序方式</li><li><strong><code>lazy</code></strong>: 如果为True, 则仅在获取时计算聚合值</li></ul></li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> dateutil<span class="token punctuation">.</span>relativedelta <span class="token keyword">import</span> relativedelta

data <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;procurement.group&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read_group<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">&#39;sale_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;in&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;ids:array_agg(id)&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;sale_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


incoming_moves <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;stock.move.line&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read_group<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">&#39;product_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;in&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;done&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;picking_code&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;incoming&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&#39;date&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&gt;=&#39;</span><span class="token punctuation">,</span> fields<span class="token punctuation">.</span>Datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> relativedelta<span class="token punctuation">(</span>years<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;product_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;product_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="fields" tabindex="-1"><a class="header-anchor" href="#fields" aria-hidden="true">#</a> Fields</h3><blockquote><p><code>fields</code> 下面提供的这些方法应该也归属于 <code>Search/Read</code>, 同在模型下面的读取/查找数据, 只是这些 api 只用于操作 fields;</p></blockquote><ul><li><strong><code>Model.fields_get([allfields][, attributes])</code></strong>: 返回每个字段的定义, 返回值是一个字典;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>fields <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;sale.order&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fields_get<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;trigger&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> attributes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;type&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;selection&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;currency_field&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="search-domains" tabindex="-1"><a class="header-anchor" href="#search-domains" aria-hidden="true">#</a> Search domains</h3><p><code>domain</code> 表达式的写法, 标准的 <code>domain</code> 为一个包含多个 <code>(field_name, operator, value)</code> 元组的 <code>list</code>, 其中:</p><ul><li><strong><code>field_name</code></strong>: 字段名称, 字符类型, 可以为基本字段, 也可以是关联字段; eg: <code>&#39;street&#39;</code> or <code>&#39;partner_id.country&#39;</code>;</li><li><strong><code>operator</code></strong>: 运算符; 有效运算符有: <ul><li><strong><code>=</code></strong>: 等于;</li><li><strong><code>!=</code></strong>: 不等于;</li><li><strong><code>&gt;</code></strong>: 大于;</li><li><strong><code>&gt;=</code></strong>: 大于等于;</li><li><strong><code>&lt;</code></strong>: 小于;</li><li><strong><code>&lt;=</code></strong>: 小于等于;</li><li><strong><code>=?</code></strong>: unset 或 等于; (如果值为 None 或者是 False, 则返回 True, 否则表现为 <code>=</code> );</li><li><strong><code>=like</code></strong>: 一般用于字符模糊匹配; 其中 <code>_</code> 代表任何单个字符, <code>%</code> 代表任何零个或多个字符的字符串; eg: <code>[(&#39;name&#39;, &#39;=like&#39;, &#39;delivery_%&#39;)]</code>;</li><li><strong><code>like</code></strong>: 与 sql 里面的 <code>like</code> 相似; 用于对值进行模糊匹配; eg: <code>[(&#39;code&#39;, &#39;like&#39;, &#39;2607%&#39;)]</code>, <code>[(&#39;code&#39;, &#39;like&#39;, &#39;%2607%&#39;)]</code>;</li><li><strong><code>not like</code></strong>: 与 <code>like</code> 取反;</li><li><strong><code>ilike</code></strong>: 不区分大小写的模糊匹配; eg: <code>[(&#39;name&#39;, &#39;ilike&#39;, &#39;test%&#39;)]</code> 表示匹配字段以 <code>test</code> 开头的字符串, 不区分大小写;</li><li><strong><code>not ilike</code></strong>: 与 <code>ilike</code> 取反;</li><li><strong><code>=ilike</code></strong>: 与 <code>=like</code> 一致, 不区分大小写;</li><li><strong><code>in</code></strong>: 等于值中的任何一个选项, 值应该为 <code>list</code>; eg: <code>[(&#39;id&#39;, &#39;in&#39;, [7, 8, 12])]</code>;</li><li><strong><code>not in</code></strong>: <code>in</code> 取反;</li><li><strong><code>child_of</code></strong>: 是记录集的子级; 值可以是一项, 也可以是多项; 遵循模型中定义的 <code>_parent_name</code> 字段; eg: <code>[(&#39;order.partner_id&#39;, &#39;child_of&#39;, partner.ids)]</code>;</li><li><strong><code>parent_of</code></strong>: 是记录集的父级; 值可以是一项, 也可以是多项; 遵循模型中定义的 <code>_parent_name</code> 字段;</li></ul></li><li><strong><code>value</code></strong>: 值域;</li></ul><p>可以使用前缀形式的逻辑运算符组合 domain 条件, 其中:</p><ul><li><strong><code>&amp;</code></strong>: 逻辑 and; 用于组合多个条件;</li><li><strong><code>|</code></strong>: 逻辑 or;</li><li><strong><code>!</code></strong>: 逻辑 not;</li></ul><blockquote><p>大多数情况下, <code>!</code> 是很少使用的, 因为运算符中的 <code>!=</code>, <code>&gt;=</code> 基本上能够满足多数情况;</p></blockquote><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;ABC&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&#39;language.code&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;!=&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;en_US&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;|&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&#39;country_id.code&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;be&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&#39;country_id.code&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;de&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># 换算成 sql 表达式为:</span>
    <span class="token punctuation">(</span>name <span class="token keyword">is</span> <span class="token string">&#39;ABC&#39;</span><span class="token punctuation">)</span>
AND <span class="token punctuation">(</span>language <span class="token keyword">is</span> NOT english<span class="token punctuation">)</span>
AND <span class="token punctuation">(</span>country <span class="token keyword">is</span> Belgium OR Germany<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="domain-的运算过程" tabindex="-1"><a class="header-anchor" href="#domain-的运算过程" aria-hidden="true">#</a> domain 的运算过程</h3><p>odoo 的 domain 使用的是 <strong>波兰表示法</strong>: 运算波兰表达式时, 无需记住运算的层次, 只需要直接寻找第一个运算的操作符, 以二元运算为例, 从左至右读入表达式, 遇到一个操作符后跟随两个操作数时, 则计算, 然后将结果作为操作数替换这个操作符和两个操作数; 重复此步骤, 直至所有操作符处理完毕;</p><p>简单的说, 波兰表示法是一种操作符置于操作数前, 并且不需要括号任然能无歧义的解析表达的方法;</p><p>例如: <code>[&#39;|&#39;,&#39;&amp;&#39;,&#39;|&#39;, a , b, c, &#39;&amp;&#39;, d, e]</code></p><p>其中 <code>a, b, c, e, f, g</code> 分别是不带逻辑运算符的表达式, 表达式的运算顺序;</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>--&gt; [&#39;|&#39;,&#39;&amp;&#39;,&#39;|&#39;, a , b, c, &#39;&amp;&#39;, d, e]

--&gt; [&#39;|&#39;,&#39;&amp;&#39;, (a | b), c, &#39;&amp;&#39;, d, e]

--&gt; [&#39;|&#39;, ((a | b) &amp; c), &#39;&amp;&#39;, d, e]

--&gt; [&#39;|&#39;, ((a | b) &amp; c), (d &amp; e)]

--&gt; [(((a | b) &amp; c) | (d &amp; e))]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="unlink" tabindex="-1"><a class="header-anchor" href="#unlink" aria-hidden="true">#</a> Unlink</h3><ul><li><strong><code>Model.unlink()</code></strong>: 删除当前记录;</li></ul><h3 id="record-api" tabindex="-1"><a class="header-anchor" href="#record-api" aria-hidden="true">#</a> Record API</h3><ul><li><strong><code>Model.ids</code></strong>: 返回当前模型所有的记录集的 id;</li><li><strong><code>Model.exists() -&gt; records</code></strong>: 返回 self 中存在的记录的子集;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>user_exist <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.users&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sudo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>browse<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>Model.ensure_one()</code></strong>: 验证当前记录集是否包含一条记录;</li><li><strong><code>Model.name_get()</code></strong>: 返回一个包含记录 ID 和记录名称的元组列表; 通常用于在界面上显示记录时, 系统需要展示记录的名称而不是 ID;</li></ul><h3 id="func" tabindex="-1"><a class="header-anchor" href="#func" aria-hidden="true">#</a> Func</h3><p>odoo 的模型上还提供了一些数据集处理的函数, 能够快捷方便的对数据进行处理;</p><ul><li><strong><code>Model.filtered(func)</code></strong>: 按照条件对数据进行过滤;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>records <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;sale.order&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 只保留 amount_total &gt; 1000 的数据;</span>
filtered_records <span class="token operator">=</span> records<span class="token punctuation">.</span>filtered<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">.</span>amount_total <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token comment"># 只保留公司客户</span>
companys <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;res.partner&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filtered<span class="token punctuation">(</span><span class="token string">&quot;partner_id.is_company&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.mapped(func)</code></strong>: 可以方便地提取指定字段的数值并进行处理; 返回新的 map</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>records <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;sale.order&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 获取所有的 sale.order 记录的名称</span>
order_names <span class="token operator">=</span> records<span class="token punctuation">.</span>mapped<span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>Model.sorted(key=None, reverse=False)</code></strong>: 对数据集进行重新排序;</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>records <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&#39;sale.order&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sorted_orders <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token string">&#39;date_order&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="error-management" tabindex="-1"><a class="header-anchor" href="#error-management" aria-hidden="true">#</a> Error Management</h2><p>odoo 异常模块定义了一些核心异常类型;</p><ul><li><strong><code>odoo.exceptions.AccessDenied(message=&#39;Access Denied&#39;)</code></strong>: 错误的账号密码;</li><li><strong><code>odoo.exceptions.AccessError(message)</code></strong>: 没有权限读取数据;</li><li><strong><code>odoo.exceptions.CacheMiss(record, field)</code></strong>: 尝试读取刷新缓存中不存在的值;</li><li><strong><code>odoo.exceptions.MissingError(message)</code></strong>: 对已经删除的数据进行 <code>write</code> 的时候;</li><li><strong><code>odoo.exceptions.RedirectWarning(message, action, button_text, additional_context=None)</code></strong>: 警告, 可以重定向用户, 而不是简单地显示警告消息;</li><li><strong><code>odoo.exceptions.UserError(message)</code></strong>: 当用户试图做一些在给定记录的当前状态下没有意义的事情时候; 在语义上与通用的 400 http 状态码相似;</li><li><strong><code>odoo.exceptions.ValidationError(message)</code></strong>: 校验约束时候的错误;</li></ul>`,146),o=[e];function c(i,l){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","API.html.vue"]]);export{r as default};
